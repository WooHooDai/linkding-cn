{% load widget_tweaks %}

<div class="form-group {% if form.name.errors %}has-error{% endif %}">
  <label for="{{ form.name.id_for_label }}" class="form-label">过滤器名称</label>
  {{ form.name|add_class:"form-input"|attr:"autocomplete:off"|attr:"placeholder: " }}
  {% if form.name.errors %}
    <div class="form-input-hint">
      {{ form.name.errors }}
    </div>
  {% endif %}
</div>

<div class="form-group {% if form.search.errors %}has-error{% endif %}">
  <label for="{{ form.search.id_for_label }}" class="form-label">搜索</label>
  {{ form.search|add_class:"form-input"|attr:"autocomplete:off"|attr:"placeholder: " }}
  {% if form.search.errors %}
    <div class="form-input-hint">
      {{ form.search.errors }}
    </div>
  {% endif %}
  <div class="form-input-hint">
    匹配搜索的书签。
  </div>
</div>

<div class="form-group" ld-tag-autocomplete>
  <label for="{{ form.any_tags.id_for_label }}" class="form-label">标签</label>
  {{ form.any_tags|add_class:"form-input"|attr:"autocomplete:off"|attr:"autocapitalize:off" }}
  <div class="form-input-hint">
    书签拥有任一书签即可匹配。
  </div>
</div>

<div class="form-group" ld-tag-autocomplete>
  <label for="{{ form.all_tags.id_for_label }}" class="form-label">必选标签</label>
  {{ form.all_tags|add_class:"form-input"|attr:"autocomplete:off"|attr:"autocapitalize:off" }}
  <div class="form-input-hint">
    书签拥有所有书签方可匹配。
  </div>
</div>

<div class="form-group" ld-tag-autocomplete>
  <label for="{{ form.excluded_tags.id_for_label }}" class="form-label">排除标签</label>
  {{ form.excluded_tags|add_class:"form-input"|attr:"autocomplete:off"|attr:"autocapitalize:off" }}
  <div class="form-input-hint">
    书签不包含任一标签方可匹配。
  </div>
</div>

<div class="form-group">
  <label class="form-switch">
    {{ form.show_count }}
    <i class="form-icon"></i> 显示标签数
  </label>
  <div class="form-input-hint">
    是否在侧边栏显示该分组下的书签数量。
  </div>
</div>

<div class="form-footer d-flex mt-4">
  <input type="submit" name="save" value="保存" class="btn btn-primary btn-wide">
  <a href="{% url 'linkding:bundles.index' %}" class="btn btn-wide ml-auto">取消</a>
  <a href="{% url 'linkding:bundles.preview' %}" data-turbo-frame="preview" class="d-none" id="preview-link"></a>
</div>

<script>
  (function init() {
    const bundleForm = document.getElementById('bundle-form');
    const previewLink = document.getElementById('preview-link');

    let pendingUpdate;

    function scheduleUpdate() {
      if (pendingUpdate) {
        clearTimeout(pendingUpdate);
      }
      pendingUpdate = setTimeout(() => {
        // Ignore if link has been removed (e.g. form submit or navigation)
        if (!previewLink.isConnected) {
          return;
        }

        const baseUrl = previewLink.href.split('?')[0];
        const params = new URLSearchParams();
        const inputs = bundleForm.querySelectorAll('input[type="text"]:not([name="csrfmiddlewaretoken"]), textarea, select');

        inputs.forEach(input => {
          if (input.name && input.value.trim()) {
            params.set(input.name, input.value.trim());
          }
        });

        previewLink.href = params.toString() ? `${baseUrl}?${params.toString()}` : baseUrl;
        previewLink.click();
      }, 500)
    }

    bundleForm.addEventListener('input', scheduleUpdate);
    bundleForm.addEventListener('change', scheduleUpdate);
  })();
</script>
